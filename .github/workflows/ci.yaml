name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    tests:
        runs-on: ubuntu-latest
        env:
            GODOT_VERSION: "4.5.1"
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: ${{ env.GODOT_VERSION }}
                  use-dotnet: false

            - name: Run tests
              run: |
                  godot --headless --import
                  godot --headless --path . -s addons/gut/gut_cmdln.gd -gconfig res://test/gutconfig.json

    lint:
        runs-on: ubuntu-latest
        env:
            FORMATTER_URL: "https://api.github.com/repos/GDQuest/GDScript-formatter/releases/latest"
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download GDScript Formatter
              run: |
                  release=$(curl -s ${{ env.FORMATTER_URL }})
                  url=$(echo "$release" | grep browser_download_url | grep -i linux | cut -d '"' -f 4)

                  if [ -z "$url" ]; then
                      echo "❌ No Linux asset found in the latest release"
                      exit 1
                  fi

                  echo "Downloading: $url"

                  curl -L "$url" -o formatter.tar.gz
                  mkdir gdformatter
                  tar -xf formatter.tar.gz -C gdformatter

                  # Find binary and add to PATH
                  bin=$(find gdformatter -type f -name "gdscript-formatter" -o -name "gdscript-formatter-linux" | head -n 1)

                  if [ -z "$bin" ]; then
                      echo "❌ gdscript-formatter binary not found"
                      exit 1
                  fi

                  chmod +x "$bin"
                  echo "$(dirname "$bin")" >> $GITHUB_PATH

            - name: Lint
              shell: bash
              run: |
                  mapfile -t files < <(find . -type f -name "*.gd" \
                      -not -path "*/addons/*" \
                      -not -path "*/build/*" \
                      -not -path "*/.git/*")

                  if [ ${#files[@]} -eq 0 ]; then
                      echo "No .gd files found (after exclusions)."
                      exit 0
                  fi

                  gdscript-formatter lint --pretty "${files[@]}"
